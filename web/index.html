<head>
    <title>Web Remote Control</title>
    <style>
        fieldset {
            padding: 20px;
        }
    </style>
    <script src="/socket.io.min.js" 
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
        crossorigin="anonymous"></script>
    <script>
        var socket = io.connect('http://localhost:8080');
        window.onload = () => {
            // start by hiding the error message
            document.querySelector('#error').style.display = 'none';
            // show the elements at half transparency, until page loaded.
            // document.querySelector('#ui').style.opacity = 0.5;

            socket.on('connect', (data) => {
                // return page elements back to normal on successful connection.
                // document.querySelector('#ui').style.opacity = 1;

                let locked = false;   // creating a semaphore for preventing congestion
                function step(motor, c) {
                    if (!locked) {
                        locked = true;
                        fetch('/rtt/' + Date.now())
                            .then((res) => {
                                socket.emit(`${motor}:step`, c);
                                locked = false;
                            });
                    }
                }

                let key = 'KeyA', clockwise = false;
                document.onkeydown = event => {
                    switch (event.code) {
                        case 'KeyA':
                        case 'KeyB':
                        case 'KeyC': {
                            key = event.code.replace('Key', '');   // set the motor to key pressed
                            document.querySelector("#key").textContent = key;
                            break;
                        }
                        case 'Space': {
                            clockwise = !clockwise;
                            document.querySelector("#pol").textContent = clockwise ? 'cw' : 'ccw';
                            break;
                        }
                        default: {
                            console.log(new Date(), 'ignoring key pressed', event.code);
                        }
                    }
                    step(`motor${key}`, clockwise ? 'cw' : 'ccw');
                };

                socket.on('disconnect', () => {
                    // show the error message on server-side socket disconnect.
                    document.querySelector('#error').style.display = 'block';
                    document.querySelector('#error').style.color = 'red';
                });
            });
        };
    </script>
</head>

<body>
    <p id="error">
        <em>NOTE: Do ensure only one instance of this page is open!</em>
    </p>

    Using wasd keys with space bar keybindings.
    (TODO: Flesh this out!)

    <p>
        Current motor <span id="key"></span><br>
        Current polarity <span id="pol"></span>
    </p>
</body>